# Drizzle ORM Setup

## What is Drizzle?

Drizzle is a lightweight TypeScript ORM for SQL databases. We chose it for TropiGo because:
- Fast and lightweight (perfect for hackathons)
- Excellent TypeScript support with auto-inferred types
- Works great with Bun
- Has Drizzle Studio - a GUI for viewing/editing data

## Our Setup

**Database:** PostgreSQL 18 (running in Docker)
**Location:** `apps/api/src/db/`

```
apps/api/src/db/
├── index.ts     # Database connection
├── schema.ts    # Table definitions
└── seed.ts      # Sample data script
```

## Installation (Already Done)

We installed:
```bash
bun add drizzle-orm postgres
bun add -d drizzle-kit
```

## Configuration Files

### 1. Database Connection (`apps/api/src/db/index.ts`)

```typescript
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'
import * as schema from './schema'

const connectionString = process.env.DATABASE_URL ||
  'postgresql://postgres:postgres@localhost:5432/tropigo'

const client = postgres(connectionString)
export const db = drizzle(client, { schema })
```

**What this does:**
- Creates a PostgreSQL client connection
- Wraps it with Drizzle ORM
- Exports `db` for use throughout the API

### 2. Drizzle Config (`apps/api/drizzle.config.ts`)

```typescript
import { defineConfig } from 'drizzle-kit'

export default defineConfig({
  schema: './src/db/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL ||
      'postgresql://postgres:postgres@localhost:5432/tropigo'
  },
})
```

**What this does:**
- Tells Drizzle Kit where to find the schema
- Specifies database connection
- Used by CLI commands like `db:push`, `db:studio`

## Available Scripts

Run these from the **root directory**:

### `bun run db:push`
**What it does:**
1. Reads your schema from `apps/api/src/db/schema.ts`
2. Compares it to your PostgreSQL database
3. Automatically creates/updates tables to match the schema
4. **No migration files generated** (fast for development)

**Use this when:**
- Setting up the database for the first time
- Making schema changes during development
- You want quick iterations in the hackathon

**Example:**
```bash
bun run db:push
# Output: ✔ Changes applied successfully!
```

### `bun run db:seed`
**What it does:**
- Runs `apps/api/src/db/seed.ts`
- Inserts sample data into your database
- Creates 3 users and 4 experiences

**Use this when:**
- You want test data to work with
- After running `db:push` for the first time
- After resetting your database

### `bun run db:studio`
**What it does:**
- Launches Drizzle Studio web GUI
- Opens at `http://localhost:4983`
- Browse tables, view/edit data, run queries

**Use this when:**
- You want to see what's in the database
- Manually add/edit/delete data
- Debug data issues

### `bun run db:generate`
**What it does:**
- Generates migration files in `apps/api/drizzle/` folder
- Compares schema to database and creates SQL migration
- Use for production (not needed for hackathon)

### `bun run db:migrate`
**What it does:**
- Runs migration files generated by `db:generate`
- Applies schema changes to database
- Use for production (not needed for hackathon)

## First-Time Setup

```bash
# 1. Start PostgreSQL
docker compose up -d

# 2. Create tables (IMPORTANT - must do this first!)
bun run db:push

# 3. Add sample data
bun run db:seed

# 4. View data in GUI
bun run db:studio
```

## db:push vs db:migrate

| Command | When to Use | Migration Files? | Speed |
|---------|-------------|------------------|-------|
| `db:push` | Development/Hackathon | No | Fast |
| `db:generate` + `db:migrate` | Production | Yes | Slower |

**For this hackathon, use `db:push`** - it's faster and easier!
